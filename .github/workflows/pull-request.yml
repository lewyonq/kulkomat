name: Pull Request CI

on:
  pull_request:
    branches: [main, master]

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Setup Node.js project
        uses: ./.github/actions/setup-node-project

      - name: Run ESLint
        run: npm run lint

      - name: Check code formatting
        run: npm run format:check

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint

    steps:
      - name: Setup Node.js project
        uses: ./.github/actions/setup-node-project

      - name: Run unit tests with coverage
        run: npm run test -- --no-watch --code-coverage --browsers=ChromeHeadless

      - name: Upload unit test coverage
        uses: actions/upload-artifact@v5
        if: always()
        with:
          name: unit-test-coverage
          path: coverage/
          retention-days: 30

  # e2e-test:
  #   name: E2E Tests
  #   runs-on: ubuntu-latest
  #   timeout-minutes: 15
  #   needs: lint
  #   environment: integration
  #   env:
  #     CI: true

  #   steps:
  #     - name: Setup Node.js project
  #       uses: ./.github/actions/setup-node-project

  #     - name: Install Playwright browsers
  #       run: npx playwright install chromium --with-deps

  #     - name: Create environment file
  #       run: |
  #         cat > src/app/environment/environment.ts << EOF
  #         export const environment = {
  #           production: false,
  #           supabase: {
  #             url: '${{ secrets.SUPABASE_URL }}',
  #             anonKey: '${{ secrets.SUPABASE_ANON_KEY }}',
  #           },
  #           auth: {
  #             redirectUri: '${{ secrets.AUTH_REDIRECT_URI }}',
  #             defaultRedirectAfterLogin: '/',
  #             defaultRedirectAfterLogout: '/login',
  #           },
  #         };
  #         EOF

  #     - name: Build application
  #       run: npm run build

  #     - name: Start application server
  #       run: |
  #         npx http-server dist/kulkomat/browser -p 4200 &
  #         echo $! > server.pid
  #         sleep 5

  #     - name: Run E2E tests with coverage
  #       env:
  #         SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  #       run: npx playwright test --project=chromium

  #     - name: Stop application server
  #       if: always()
  #       run: |
  #         if [ -f server.pid ]; then
  #           kill $(cat server.pid) || true
  #         fi

  #     - name: Upload E2E test coverage
  #       uses: actions/upload-artifact@v5
  #       if: always()
  #       with:
  #         name: e2e-test-coverage
  #         path: playwright-report/
  #         retention-days: 30

  #     - name: Upload E2E test results
  #       uses: actions/upload-artifact@v5
  #       if: always()
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 30

  status-comment:
    name: Post Status Comment
    runs-on: ubuntu-latest
    needs: [lint, unit-test]
    if: always() && needs.lint.result == 'success' && needs.unit-test.result == 'success'
    permissions:
      pull-requests: write

    steps:
      - name: Post success comment
        uses: actions/github-script@v8
        with:
          script: |
            const comment = `## ✅ CI Pipeline Passed

            All checks completed successfully:

            - ✅ **Lint**: Code quality checks passed
            - ✅ **Unit Tests**: All unit tests passed

            **Status**: Ready for review
            **Commit**: ${{ github.event.pull_request.head.sha }}
            **Triggered by**: @${{ github.actor }}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
