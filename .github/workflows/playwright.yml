name: Playwright Tests
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
jobs:
  test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: lts/*
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    - name: Create environment file
      run: |
        cat > src/app/environment/environment.ts << EOF
        export const environment = {
          production: false,
          supabase: {
            url: '${{ secrets.SUPABASE_URL }}',
            anonKey: '${{ secrets.SUPABASE_ANON_KEY }}',
          },
          auth: {
            redirectUri: '${{ secrets.AUTH_REDIRECT_URI }}',
            defaultRedirectAfterLogin: '/',
            defaultRedirectAfterLogout: '/login',
          },
        };
        EOF
    - name: Build application
      run: npm run build
    - name: Start application server
      run: |
        npx http-server dist/kulkomat/browser -p 4200 &
        echo $! > server.pid
        # Wait for server to be ready (up to 60 seconds)
        for i in {1..60}; do
          if curl -s http://localhost:4200 > /dev/null; then
            echo "Server is ready!"
            break
          fi
          echo "Waiting for server... ($i/60)"
          sleep 1
        done
    - name: Run Playwright tests
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      run: npx playwright test --project=chromium-mocked
    - name: Stop application server
      if: always()
      run: |
        if [ -f server.pid ]; then
          kill $(cat server.pid) || true
        fi
    - uses: actions/upload-artifact@v4
      if: ${{ !cancelled() }}
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
